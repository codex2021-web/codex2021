package com.codex.modelsheet.controller;

import cloud.thoughtspotstaging.champagne.TSClient;
import cloud.thoughtspotstaging.champagne.controllers.SessionController;
import cloud.thoughtspotstaging.champagne.controllers.TMLController;
import cloud.thoughtspotstaging.champagne.exceptions.ApiException;
import com.codex.modelsheet.helper.ConfigInfo;
import sun.misc.IOUtils;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.stream.Collectors;

public class ImportDMWorkSheet extends BaseController{
    TSClient client = null;
    public ImportDMWorkSheet() throws Exception {
        super();
    }

    public void importWorkSheet(String jsonArrayTmls) throws IOException, ApiException {
        //Input of import worksheet looks below
        String jsonArrayOfTmlsss = "{\n" +
                "   \"objects\":[\n" +
                "      {\n" +
                "         \"edoc\":\"guid: db767288-f968-47ae-aa45-1228e0309e26\\nworksheet:\\n  name: Supplier Worksheet\\n  tables:\\n  - name: PRODUCT\\n  - name: PRODUCTCATEGORY\\n  - name: PURCHASETRANSACTIONS\\n  - name: SUPPLY\\n  joins:\\n  - name: Mapping between PRODUCTCATEGORY and PRODUCT\\n    source: PRODUCT\\n    destination: PRODUCTCATEGORY\\n    type: INNER\\n    is_one_to_one: false\\n  - name: Mapping between PRODUCT and PURCHASETRANSACTIONS\\n    source: PURCHASETRANSACTIONS\\n    destination: PRODUCT\\n    type: INNER\\n    is_one_to_one: false\\n  - name: Mapping between SUPPLIER and PURCHASETRANSACTIONS\\n    source: PURCHASETRANSACTIONS\\n    destination: SUPPLY\\n    type: INNER\\n    is_one_to_one: false\\n  table_paths:\\n  - id: PRODUCT_1\\n    table: PRODUCT\\n    join_path:\\n    - join:\\n      - Mapping between PRODUCT and PURCHASETRANSACTIONS\\n  - id: PRODUCTCATEGORY_1\\n    table: PRODUCTCATEGORY\\n    join_path:\\n    - join:\\n      - Mapping between PRODUCT and PURCHASETRANSACTIONS\\n      - Mapping between PRODUCTCATEGORY and PRODUCT\\n  - id: PURCHASETRANSACTIONS_1\\n    table: PURCHASETRANSACTIONS\\n    join_path:\\n    - {}\\n  - id: SUPPLY_1\\n    table: SUPPLY\\n    join_path:\\n    - join:\\n      - Mapping between SUPPLIER and PURCHASETRANSACTIONS\\n  formulas:\\n  - name: is_us_company\\n    expr: \\\"if ( [SUPPLY_1::COMPANY_NAME] = 'united states' ) then true else false\\\"\\n  - name: qualified product name\\n    expr: \\\"concat ( concat ( concat ( concat ( [SUPPLY_1::COMPANY_NAME] , '_' ) , [PRODUCT_1::Product Group_NAME] ) , '_' ) , [PRODUCT_1::PRODUCT_NAME] )\\\"\\n  worksheet_columns:\\n  - name: Product Group KEY\\n    column_id: \\\"PRODUCT_1::Product Group_KEY\\\"\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n  - name: Product Category\\n    column_id: \\\"PRODUCTCATEGORY_1::Product Category\\\"\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n  - name: COMPANY NAME\\n    column_id: \\\"SUPPLY_1::COMPANY_NAME\\\"\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n  - name: COMPANY KEY\\n    column_id: \\\"SUPPLY_1::COMPANY_KEY\\\"\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n  - name: COUNTRY NAME\\n    column_id: \\\"SUPPLY_1::COUNTRY_NAME\\\"\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n  - name: Product Group\\n    column_id: \\\"PRODUCTCATEGORY_1::Product Group\\\"\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n  - name: PREVUNITCOST\\n    column_id: \\\"PURCHASETRANSACTIONS_1::PREVUNITCOST\\\"\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n  - name: ITEMCOUNT\\n    column_id: \\\"PURCHASETRANSACTIONS_1::ITEMCOUNT\\\"\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n  - name: Is us company\\n    formula_id: is_us_company\\n    properties:\\n      column_type: ATTRIBUTE\\n  - name: Qualified product name\\n    formula_id: qualified product name\\n    properties:\\n      column_type: ATTRIBUTE\\n  properties:\\n    is_bypass_rls: false\\n    join_progressive: true\\n\",\n" +
                "         \"type\":\"WORKSHEET\",\n" +
                "         \"action\":\"CREATE\",\n" +
                "         \"filename\":\"Supplier Worksheet.worksheet.tml\"\n" +
                "      },\n" +
                "      {\n" +
                "         \"edoc\":\"guid: 4b8896eb-4c83-40f9-be54-c8164326958e\\ntable:\\n  name: SUPPLY\\n  db: SUPPLYCHAIN_MAIN\\n  schema: PUBLIC\\n  db_table: SUPPLIER\\n  connection:\\n    name: SnowflakeConnection\\n  columns:\\n  - name: COMPANY_KEY\\n    db_column_name: COMPANY_KEY\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: COMPANY_NAME\\n    db_column_name: COMPANY_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: COUNTRY_NAME\\n    db_column_name: COUNTRY_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: STATE_NAME\\n    db_column_name: STATE_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: CITY_NAME\\n    db_column_name: CITY_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: POSTALCODE_NAME\\n    db_column_name: POSTALCODE_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: PAYMENTTERMS_NAME\\n    db_column_name: PAYMENTTERMS_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: PAYMENTTERMSSCORE_KEY\\n    db_column_name: PAYMENTTERMSSCORE_KEY\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: PAYMENTTERMSSCORE_NAME\\n    db_column_name: PAYMENTTERMSSCORE_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n\",\n" +
                "         \"type\":\"TABLE\",\n" +
                "         \"action\":\"CREATE\",\n" +
                "         \"filename\":\"SUPPLY.table.tml\"\n" +
                "      },\n" +
                "      {\n" +
                "         \"edoc\":\"guid: 7c9d6e4d-cee4-4d03-a062-62e26804ac02\\ntable:\\n  name: PRODUCT\\n  db: SUPPLYCHAIN_MAIN\\n  schema: PUBLIC\\n  db_table: PRODUCT\\n  connection:\\n    name: SnowflakeConnection\\n  columns:\\n  - name: Product Group_KEY\\n    db_column_name: Product Group_KEY\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: Product Group_NAME\\n    db_column_name: Product Group_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: PRODUCT_KEY\\n    db_column_name: PRODUCT_KEY\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: PRODUCT_NAME\\n    db_column_name: PRODUCT_NAME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  joins_with:\\n  - name: Mapping between PRODUCTCATEGORY and PRODUCT\\n    destination:\\n      name: PRODUCTCATEGORY\\n    \\\"on\\\": \\\"[PRODUCT::Product Group_NAME] = [PRODUCTCATEGORY::Product Group]\\\"\\n    type: INNER\\n\",\n" +
                "         \"type\":\"TABLE\",\n" +
                "         \"action\":\"CREATE\",\n" +
                "         \"filename\":\"PRODUCT.table.tml\"\n" +
                "      },\n" +
                "      {\n" +
                "         \"edoc\":\"guid: 7f7880b9-b311-4eb2-a6d3-5d053b50b724\\ntable:\\n  name: PURCHASETRANSACTIONS\\n  db: SUPPLYCHAIN_MAIN\\n  schema: PUBLIC\\n  db_table: PURCHASETRANSACTIONS\\n  connection:\\n    name: SnowflakeConnection\\n  columns:\\n  - name: PURCHID\\n    db_column_name: PURCHID\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: LINENUM\\n    db_column_name: LINENUM\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: ITEMID\\n    db_column_name: ITEMID\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: ORDERACCOUNT\\n    db_column_name: ORDERACCOUNT\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: INVOICEACCOUNT\\n    db_column_name: INVOICEACCOUNT\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: CREATEDDATETIME\\n    db_column_name: CREATEDDATETIME\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DATE\\n  - name: ORDERPLACER\\n    db_column_name: ORDERPLACER\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: RECID\\n    db_column_name: RECID\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: PURCHSTATUS\\n    db_column_name: PURCHSTATUS\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: QTYORDERED\\n    db_column_name: QTYORDERED\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: QTYRECEIVED\\n    db_column_name: QTYRECEIVED\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: LINEAMOUNT\\n    db_column_name: LINEAMOUNT\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: ONTIMEDELIVEREDQTY\\n    db_column_name: ONTIMEDELIVEREDQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: EARLYDAYS\\n    db_column_name: EARLYDAYS\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: EARLY\\n    db_column_name: EARLY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: LATEDAYS\\n    db_column_name: LATEDAYS\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: LATE\\n    db_column_name: LATE\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: EARLYLATEDETERMINATE\\n    db_column_name: EARLYLATEDETERMINATE\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: FULLSHIPMENTQTY\\n    db_column_name: FULLSHIPMENTQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: PARTIALSHIPMENTQTY\\n    db_column_name: PARTIALSHIPMENTQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: ONTIMEFULLDELIVEREDQTY\\n    db_column_name: ONTIMEFULLDELIVEREDQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: ONTIMEPARTIALDELIVEREDQTY\\n    db_column_name: ONTIMEPARTIALDELIVEREDQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: ACCEPTQTY\\n    db_column_name: ACCEPTQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: REJECTQTY\\n    db_column_name: REJECTQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: LEADTIME\\n    db_column_name: LEADTIME\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: DATEDELIVERED\\n    db_column_name: DATEDELIVERED\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DATE\\n  - name: ORIGREQUESTEDDLV\\n    db_column_name: ORIGREQUESTEDDLV\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DATE\\n  - name: EARLYQTY\\n    db_column_name: EARLYQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: LATEQTY\\n    db_column_name: LATEQTY\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: CURUNITCOST\\n    db_column_name: CURUNITCOST\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: PREVUNITCOST\\n    db_column_name: PREVUNITCOST\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: EPPV\\n    db_column_name: EPPV\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: EPPVPARTPERCENT\\n    db_column_name: EPPVPARTPERCENT\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: DOUBLE\\n  - name: AGECLASS\\n    db_column_name: AGECLASS\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: OPENCLOSED\\n    db_column_name: OPENCLOSED\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  - name: ITEMCOUNT\\n    db_column_name: ITEMCOUNT\\n    properties:\\n      column_type: MEASURE\\n      aggregation: SUM\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: INT64\\n  joins_with:\\n  - name: Mapping between SUPPLIER and PURCHASETRANSACTIONS\\n    destination:\\n      name: SUPPLY\\n    \\\"on\\\": \\\"[PURCHASETRANSACTIONS::ORDERACCOUNT] = [SUPPLY::COMPANY_KEY]\\\"\\n    type: INNER\\n  - name: Mapping between PRODUCT and PURCHASETRANSACTIONS\\n    destination:\\n      name: PRODUCT\\n    \\\"on\\\": \\\"[PURCHASETRANSACTIONS::ITEMID] = [PRODUCT::PRODUCT_KEY]\\\"\\n    type: INNER\\n\",\n" +
                "         \"type\":\"TABLE\",\n" +
                "         \"action\":\"CREATE\",\n" +
                "         \"filename\":\"PURCHASETRANSACTIONS.table.tml\"\n" +
                "      },\n" +
                "      {\n" +
                "         \"edoc\":\"guid: c1a32849-6e99-428e-abef-39f273b2cd95\\ntable:\\n  name: PRODUCTCATEGORY\\n  db: SUPPLYCHAIN_MAIN\\n  schema: PUBLIC\\n  db_table: PRODUCTCATEGORY\\n  connection:\\n    name: SnowflakeConnection\\n  columns:\\n  - name: Product Category\\n    db_column_name: Product Category\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n  - name: Product Group\\n    db_column_name: Product Group\\n    properties:\\n      column_type: ATTRIBUTE\\n      index_type: DONT_INDEX\\n    db_column_properties:\\n      data_type: VARCHAR\\n\",\n" +
                "         \"type\":\"TABLE\",\n" +
                "         \"action\":\"CREATE\",\n" +
                "         \"filename\":\"PRODUCTCATEGORY.table.tml\"\n" +
                "      }\n" +
                "   ]\n" +
                "}";

        client = BaseController.createConfiguration();
        String authToken = getAuthToken();
        TMLController controller = client.getTMLController();

        String accept = "text/plain";
        String username = ConfigInfo.getConfigs().getProperty("username");

        controller.importWorksheet(username, jsonArrayTmls, authToken, accept);

        String response = new BufferedReader(
                new InputStreamReader(httpResponse.getResponse().getRawBody(), StandardCharsets.UTF_8))
                .lines()
                .collect(Collectors.joining("\n"));
        System.out.println("Export Worksheet Response: "+response);
    }
    public String getAuthToken() throws IOException, ApiException {

        String contentType = "application/x-www-form-urlencoded";
        String accept = "text/plain";
        String xRequestedBy = "ThoughtSpot";
        String username = ConfigInfo.getConfigs().getProperty("username");//"srikanth.jandhyala@thoughtspot.com";
        String password = ConfigInfo.getConfigs().getProperty("password");//"Test@1986";
        String access_level = "FULL";
        // Set callback and perform API call
        SessionController sessionControl = client.getSessionController();
        sessionControl.getAuthToken(password, username, access_level, contentType, accept, xRequestedBy);
        String authToken = new String(IOUtils.readFully(httpResponse.getResponse().getRawBody(), -1, true));
        System.out.println(authToken);
        //controller.login(username, password, rememberme, contentType, accept, xRequestedBy);
        return  authToken;
    }
}
